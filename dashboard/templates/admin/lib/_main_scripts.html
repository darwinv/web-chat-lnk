{% load static i18n api_tools %}
<!-- Este archivo es llamado por toda la App para cumplir funciones  -->
<!-- personalizadas para 2 o mas vistas -->
<script>
	$(function () {
	// get globar api var traidas desde api_tools
	{% autoescape off %}
		var urlBase   		= '{% get_api_url %}';	
		var headers  		= {% get_api_header %}; //Retorna un Objeto
	{% endautoescape %}	

    $(document).on('change', '#id_department', function() {
    	url 	= urlBase+'provinces'
    	id 		= $(this).val();
    	element = $('#id_province');
    	elementB= $('#id_district');

    	clearOptions(element)
    	clearOptions(elementB)
    	data = {'department': id}
    	msg  = sendAjaxGeo(url,data,element);
	});

	$(document).on('change', '#id_province', function() {
    	url 	= urlBase+'districts'
    	id 		= $(this).val();
    	element = $('#id_district');

    	clearOptions(element)
    	data = {'province': id}
    	msg  = sendAjaxGeo(url,data,element);
	});
    
	function sendAjaxGeo(url,data,element,type="GET"){
		var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();
		$.ajax({
		  type: type,
		  beforeSend: function(request, settings) {
		  	if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
	            request.setRequestHeader("X-CSRFToken", csrftoken);
	        }
	        // Recorremos cabeceras
		    for (var key in headers){
			    if (headers.hasOwnProperty(key)) {
			         request.setRequestHeader(key, headers[key]);
			    }
			}
		  },
		  url: url,
		  data:data,
		  dataType: "json",
		  success: function(msg) {
			generateOptions(element,msg.results);
		  }
		});
	}
	function generateOptions(element,data) {
			element.append('<option>{% trans "select"|title %}</option>')
			$.each(data, function(){
				element.append('<option value="'+ this.name +'">'+ this.name +'</option>')			
			});
	}

	function clearOptions(element){
		element.find('option').remove();
	}


	// Funciones genericas para borrar desde listado
	//
	// Cuando se preciona guardar imagen desde Modal
	var $modalConfirmDelete	= $('#confirm-delete'),
		icoDelete 			= '.ico-delete-row',
		btnDelete 			= '.btn-delete-ok';

    $(document).on('click',icoDelete,function(){
    	var dataAttr = $(this).data()

    	$.each(dataAttr, function(key, value) {
    		$(btnDelete).data(key,value);
        });
    	console.log("seee");
    	$modalConfirmDelete.modal('show');
	});

	$(document).on('click',btnDelete,function(){
		event.preventDefault();		
		id 		= $(this).data('id');
    	url 	= $(this).data('url');
    	data 	= {'id': id}
    	console.log(data);
    	sendAjaxDelete(url,data,'POST');
	});

	function sendAjaxDelete(url,data,type='POST'){
		var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();
		$.ajax({
		  type: type,
		  beforeSend: function(request, settings) {
		  	if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
	            request.setRequestHeader("X-CSRFToken", csrftoken);
	        }
	        // Recorre cabeceras por clave y valor
		    for (var key in headers){
			    if (headers.hasOwnProperty(key)) {
			         request.setRequestHeader(key, headers[key]);
			    }
			}
		  },
		  url: url,
		  data:data,
		  dataType: "json",
		  success: function(msg) {
			location.reload();
		  }
		});
	}
	function csrfSafeMethod(method) {
	    // these HTTP methods do not require CSRF protection
	    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
	}
	// using jQuery
	function getCookie(name) {
	    var cookieValue = null;
	    if (document.cookie && document.cookie !== '') {
	        var cookies = document.cookie.split(';');
	        for (var i = 0; i < cookies.length; i++) {
	            var cookie = jQuery.trim(cookies[i]);
	            // Does this cookie string begin with the name we want?
	            if (cookie.substring(0, name.length + 1) === (name + '=')) {
	                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
	                break;
	            }
	        }
	    }
	    return cookieValue;
	}


 
	    // Show dropdown
	    $('.selected').click(function () {
	        $('.custom-sel').addClass('show-sel');
	        $('.custom-sel a').removeClass('hidden');
	    });

	    // Hide dropdown when not focused
	    $('.custom-sel').focusout(function () {
	        $('.custom-sel').removeClass('show-sel');
	        $('.custom-sel a:not(:first)').addClass('hidden');
	    }).blur(function () {
	        $('.custom-sel').removeClass('show-sel');
	        $('.custom-sel a:not(:first)').addClass('hidden');
	    });


	
	});
	
</script>